<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>对B站UP主“赛万味超人”寂静岭F视频的弹幕分析</title>
    <!-- 引入Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- 引入ECharts词云扩展 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background-color: #343a40;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            text-align: center;
        }
        .section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .section-title {
            color: #343a40;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .chart-container {
            width: 100%;
            height: 400px;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .result-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-index {
            font-weight: bold;
            color: #007bff;
            margin-right: 10px;
        }
        .alert {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>对B站UP主“赛万味超人”寂静岭F视频的弹幕分析</h1>
        </div>
    </div>

    <div class="container">
        <!-- 搜索区域 -->
        <div class="section">
            <h2 class="section-title">关键词搜索</h2>
            <div class="search-container">
                <div class="input-group">
                    <input type="text" id="search-input" class="form-control" placeholder="请输入关键词进行搜索" aria-label="搜索关键词">
                    <button class="btn btn-primary" type="button" id="search-btn">搜索</button>
                </div>
            </div>
            <div class="result-container" id="search-results">
                <div class="text-center text-muted py-5">
                    请输入关键词进行搜索
                </div>
            </div>
        </div>

        <!-- 词云图区域 -->
        <div class="section">
            <h2 class="section-title">弹幕高频词云图</h2>
            <div id="wordcloud-chart" class="chart-container"></div>
        </div>

        <!-- 情感分布图区域 -->
        <div class="section">
            <h2 class="section-title">弹幕情感分布图</h2>
            <div id="sentiment-chart" class="chart-container"></div>
        </div>
    </div>

    <!-- 引入JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 初始化词云图
        function initWordCloud() {
            const wordcloudChart = echarts.init(document.getElementById('wordcloud-chart'));
            
            // 直接加载本地词频数据文件
            fetch('word_freq_data.json')
                .then(response => response.json())
                .then(data => {
                    const wordList = data.slice(0, 100).map(item => ({
                        name: item.word,
                        value: item.freq
                    }));

                    const option = {
                        title: {
                            text: '弹幕高频词TOP100',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: '{a} <br/>{b}: {c}'
                        },
                        series: [{
                            name: '弹幕高频词',
                            type: 'wordCloud',
                            shape: 'circle',
                            left: 'center',
                            top: 'center',
                            width: '90%',
                            height: '90%',
                            right: null,
                            bottom: null,
                            sizeRange: [12, 60],
                            rotationRange: [-45, 45],
                            rotationStep: 15,
                            gridSize: 8,
                            drawOutOfBound: false,
                            textStyle: {
                                fontFamily: 'Microsoft YaHei, sans-serif',
                                fontWeight: 'normal',
                                color: function () {
                                    return 'rgb(' + [
                                        Math.round(Math.random() * 100 + 50),
                                        Math.round(Math.random() * 100 + 50),
                                        Math.round(Math.random() * 200 + 55)
                                    ].join(',') + ')';
                                }
                            },
                            emphasis: {
                                textStyle: {
                                    shadowBlur: 10,
                                    shadowColor: '#333'
                                }
                            },
                            data: wordList
                        }]
                    };

                    wordcloudChart.setOption(option);
                })
                .catch(error => {
                    console.error('加载词频数据出错:', error);
                    showAlert('加载词频数据出错', 'danger');
                });

            // 响应窗口大小变化
            window.addEventListener('resize', () => {
                wordcloudChart.resize();
            });
        }

        // 初始化情感分布图
        function initSentimentChart() {
            const sentimentChart = echarts.init(document.getElementById('sentiment-chart'));

            // 直接加载本地情感分析数据文件
            fetch('sentiment_data.json')
                .then(response => response.json())
                .then(data => {
                    const distribution = data.sentiment_distribution;
                    
                    // 准备数据
                    const sentimentTypes = Object.keys(distribution);
                    const values = Object.values(distribution).map(v => v * 100); // 转换为百分比
                    const colors = ['#52c41a', '#ff7875', '#faad14']; // 正面-绿色，负面-红色，中性-黄色

                    const option = {
                        title: {
                            text: `弹幕情感分布 (总计: ${data.total_danmu}条)`,
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: '{a} <br/>{b}: {c}% ({d}%)'
                        },
                        legend: {
                            orient: 'horizontal',
                            bottom: 10,
                            data: sentimentTypes
                        },
                        series: [{
                            name: '情感类型',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 10,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: true,
                                formatter: '{b}\n{c}%'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: '18',
                                    fontWeight: 'bold'
                                }
                            },
                            labelLine: {
                                show: true
                            },
                            data: sentimentTypes.map((type, index) => ({
                                value: values[index].toFixed(1),
                                name: type,
                                itemStyle: {
                                    color: colors[index]
                                }
                            }))
                        }]
                    };

                    sentimentChart.setOption(option);
                })
                .catch(error => {
                    console.error('加载情感分析数据出错:', error);
                    showAlert('加载情感分析数据出错', 'danger');
                });

            // 响应窗口大小变化
            window.addEventListener('resize', () => {
                sentimentChart.resize();
            });
        }

        // 初始化搜索功能
        function initSearch() {
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const searchResults = document.getElementById('search-results');

            // 加载本地弹幕数据
            let allDanmu = [];
            fetch('bilibili_danmu.txt')
                .then(response => response.text())
                .then(text => {
                    allDanmu = text.split('\n').filter(line => line.trim() !== '');
                })
                .catch(error => {
                    console.error('加载弹幕数据出错:', error);
                    showAlert('加载弹幕数据出错，搜索功能可能无法使用', 'warning');
                });

            function performSearch() {
                const keyword = searchInput.value.trim();
                if (!keyword) {
                    showAlert('请输入关键词', 'warning');
                    return;
                }

                // 清空之前的结果并显示加载提示
                searchResults.innerHTML = '<div class="text-center text-muted py-5">正在搜索中...</div>';

                // 本地执行搜索
                const results = [];
                const regex = new RegExp(keyword, 'i');
                
                for (let i = 0; i < allDanmu.length; i++) {
                    const line = allDanmu[i].trim();
                    if (regex.test(line)) {
                        // 解析弹幕内容
                        let content = line;
                        const dotPos = line.indexOf('.');
                        if (dotPos !== -1) {
                            content = line.slice(dotPos + 1).trim();
                        }
                        
                        results.push({
                            index: i + 1,
                            content: content
                        });
                        
                        // 限制返回数量
                        if (results.length >= 50) {
                            break;
                        }
                    }
                }

                // 显示搜索结果
                if (results.length > 0) {
                    let html = `<div class="alert alert-info">找到 ${results.length} 条包含关键词 "${keyword}" 的弹幕</div>`;
                    html += '<div class="list-group">';
                    
                    results.forEach(item => {
                        html += `
                            <div class="list-group-item result-item">
                                <span class="result-index">${item.index}.</span>
                                <span class="result-content">${item.content}</span>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    searchResults.innerHTML = html;
                } else {
                    searchResults.innerHTML = `<div class="alert alert-secondary">未找到包含关键词 "${keyword}" 的弹幕</div>`;
                }
            }

            // 绑定搜索按钮点击事件
            searchBtn.addEventListener('click', performSearch);

            // 绑定回车键事件
            searchInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    performSearch();
                }
            });
        }

        // 显示提示信息
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.role = 'alert';
            alert.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
            
            // 添加到body并自动移除
            document.body.appendChild(alert);
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initWordCloud();
            initSentimentChart();
            initSearch();
        });
    </script>
</body>
</html>
